#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const program = require('commander');
const spawn = require('child_process').spawn;

program
    .option('-o, --output <output>', 'output path')
    .option('-f, --force', 'force build')
    .option('--global-css [css]', 'global css path')
    .option('-c, --config [config]', 'vusion cli config,eg: "theme=dark no-clean"')
    .option('-t, --theme [theme]', 'cloud ui theme')
    .parse(process.argv);

const root = process.cwd();
let cloudUI = path.resolve(root, './node_modules/cloud-ui.vusion');
if (!fs.existsSync(cloudUI)) {
    cloudUI = path.resolve(__dirname, '../');
}
const protoUI = path.resolve(root, './node_modules/proto-ui.vusion');
const cloudUIVersion = require(path.join(cloudUI, './package.json')).version;
const protoUIVersion = require(path.join(protoUI, './package.json')).version;
const version = `${cloudUIVersion}-${protoUIVersion}`;
if (!program.output) {
    throw new Error('must have a output');
}
let isCached = false;
const cachePath = path.join(root, program.output, '.version');
if (fs.existsSync(cachePath)) {
    isCached = fs.readFileSync(cachePath).toString() === version;
}
if (program.force || !isCached) {
    let globalCSSPath = '';
    if (program.globalCss) {
        globalCSSPath = path.join(root, program.globalCss);
    }
    const output = path.join(root, program.output);
    const entryPath = path.join(__dirname, `../${program.theme ? `theme-${program.theme}` : 'index'}/index.js`);
    let config = '';
    if (program.config) {
        config = program.config.split(' ').filter((i) => i).map((item) => {
            return '--' + item.split('=').join(' ');
        }).join(' ');
    }
    const vusion = spawn('npx', `vusion-ui-build ${config} -c ./vusion.ui.config.js -o ${output} --global-css ${globalCSSPath} -e ${entryPath}`.split(' ').filter((i) => i), {
        cwd: path.join(__dirname, '../'),
        stdio: 'inherit',
    });
    vusion.on('close', (code) => {
        if (code !== 0)
            console.info(`vusion process exited with code ${code}`);
        else {
            fs.writeFileSync(cachePath, version);
            console.info('done.');
        }
    });
} else if (isCached) {
    console.info('done.(from cache)');
}
